<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="An awesome task timer application.">

    <title>Task Timer App</title>

    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">

    <!-- <link rel="apple-touch-icon" href="icon.png"> -->
    <!-- Place favicon.ico in the root directory -->

    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;700&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <link rel="stylesheet" href="css/main.css?v=000">

    <meta name="theme-color" content="#fafafa">

    <style id="local-styles"></style>

</head>
<body id="view" class="view app-view">

<!-- 
            1. Download html5boilerplate
            2. create data folder  
            3. create assets folder  
            3. create components folder  
            4. rename img folder to media
            5. move media folder to assets
            4. create icons folder in assets
            5. copy hamburger and other icons to media/icons/
            6. create css/mediaqueries.css with below template
            7. rename main.css html5boilerplate.css
            8. create css/main.css with below template
            9. replace contents of index.html with below template
            10. import libraries if necessary
-->

<!-- <span class="material-icons">add</span> -->
<!-- <span class="material-icons">play_arrow</span> -->
<!-- <span class="material-icons">stop</span> -->
<!-- <span class="material-icons">navigate_next</span> -->



    <!-- #region || navigation -->
    <!-- <nav id="navigation" class="navigation">navigation</nav> -->
    <!-- #endregion || navigation -->


    


    <!-- #region || content -->
    <div class="content">




    
        <!-- #region || header -->
        <header id="header" class="header container">



            <h1 class="page-title">
                Timer Name
            </h1>


            <span data-action="create" class="add-timer-button material-icons">add</span>
            


        </header>
        <!-- #endregion || header -->





        <!-- #region || toolbar -->
        <!-- <div id="toolbar" class="toolbar"></div> -->
        <!-- #endregion || toolbar -->





        <!-- #region || main -->
        <main id="main" class="main">
            
            <div class="tasklist--container">

                <h2 class="tasklist--title">Directory Name</h2>
                                
                <ul class="tasklist">





                </ul>

            </div>


        </main>
        <!-- #endregion || main -->





        <!-- #region || footer -->
        <!-- <footer id="footer" class="footer">footer</footer> -->
        <!-- #endregion || footer -->




        
    </div>
    <!-- #endregion || content -->





    <!-- <script src="js/vendor/modernizr-3.11.2.min.js"></script> -->
    <!-- <script src="js/plugins.js?v=000"></script> -->
    <!-- <script src="js/main.js?v=000"></script> -->
    <script type="module" src="./js/main.js?v=000"></script>





    <script>

        let isTouchDevice;
        let taskList = document.querySelector('.tasklist')
        let tasks = []
        let holdTimer;
        let holdDuration = 1000

        function detectTouchDevice() {
            'ontouchstart' in window ? isTouchDevice = true :  isTouchDevice = false
        }



        /* #region || task class */
        class Task {
            constructor(title = "unnamed", subtitle = ""){
                this._id = new Date().getTime()
                this._title = title
                this._subtitle = subtitle
                this._active = false
                this._history = []
                this.timer;
            }

            get id(){
                return this._id
            }

            get title(){
                return this._title
            }

            get subtitle(){
                return this._subtitle
            }

            get active(){
                return this._active
            }

            get taskElement(){
                return document.querySelector(`[data-task-id='${this.id}']`)
            }

            get modButtons(){
                return this.taskElement.querySelector('.task--modMenu').querySelectorAll('button')
            }

            toggleTimer(){

                let currentTime = new Date().getTime()

                if (this._history.length === 0 || this._history[this._history.length - 1].length === 2) {
                    this._history.push([currentTime])
                    this.startTimer()
                    this._active = true
                } else {
                    this._history[this._history.length - 1].push(currentTime)
                    this._active = false
                    this.stopTimer()
                }

                return currentTime
            }

            startTimer(){
                this.timer = setInterval(this.updateTimerElement.bind(this), 1000);
            }

            updateTimerElement(){
                this.setTimerElement(this.getTotalTime())
            }

            stopTimer(){
                clearInterval(this.timer)
            }

            getTotalTime(){
                let tempHistory = this._history.map(item => item.slice())
                if (tempHistory.length > 0 && tempHistory[tempHistory.length - 1].length !== 2) {
                    let currentTime = new Date().getTime()
                    tempHistory[tempHistory.length - 1].push(currentTime)
                }
                let sumTimeOfHistory = tempHistory.reduce((previous, current) => {
                    return (current[1] - current[0]) + previous
                },0)
                return sumTimeOfHistory
            }

            setTimerElement(timeInMilliseconds = 0){

                let hrsElement = this.taskElement.querySelector('[data-hrs]')
                let minElement = this.taskElement.querySelector('[data-min]')
                let secElement = this.taskElement.querySelector('[data-sec]')

                let hrs = timeInMilliseconds / 3600000
                let min = (hrs % 1) * 60
                let sec = (min % 1) * 60

                let time = [hrs,min,sec]

                time = time.map(num => {
                    return Math.floor(num).toString().padStart(2,'0')
                })

                hrsElement.textContent = time[0]
                minElement.textContent = time[1]
                secElement.textContent = time[2]
            }

            addListeners(){
                this.taskElement.addEventListener('click', this.eventHandler)

                if (isTouchDevice) {
                    this.taskElement.addEventListener('touchstart', this.longHoldHandler)
                    this.taskElement.addEventListener('touchend', this.longHoldHandler)
                } else {
                    this.taskElement.addEventListener('mousedown', this.longHoldHandler)
                    this.taskElement.addEventListener('mouseup', this.longHoldHandler)
                }
                
                this.modButtons.forEach( button => {
                    button.addEventListener('blur', this.clickAwayFromModMenu)
                }); 

            }

            removeListeners(){
                this.taskElement.removeEventListener('click', this.eventHandler)

                if (isTouchDevice) {
                    this.taskElement.removeEventListener('touchstart', this.longHoldHandler)
                    this.taskElement.removeEventListener('touchend', this.longHoldHandler)
                } else {
                    this.taskElement.removeEventListener('mousedown', this.longHoldHandler)
                    this.taskElement.removeEventListener('mouseup', this.longHoldHandler)
                }

                this.modButtons.forEach( button => {
                    button.removeEventListener('blur', this.clickAwayFromModMenu)
                }); 

            }

            eventHandler(e){

                let targetButton = e.target.dataset.action ||
                        e.target.parentNode.dataset.action ||
                        e.target.parentNode.parentNode.dataset.action

                let targetTask = tasks.find(task => task.id == this.dataset.taskId)
                
                switch (targetButton) {
                    case "toggle":
                        targetTask.toggleTimer()
                        break;
                
                    case "open":
                        console.log("open")
                        break;
                
                    case "edit":
                        console.log("edit")
                        break;
                
                    case "delete":
                        targetTask.deleteTask()
                        break;
                
                    default:
                        console.log("main")
                        break;
                }

                backupTasksToLocalStorage()
            }

            createTaskElement(){
                if(this.taskElement) return new Error("Element already exists")

                let newTaskElement = document.querySelector('.task-template').content.cloneNode(true)
                    newTaskElement.querySelector('.task--title').textContent = this.title
                    newTaskElement.querySelector('.task--subtitle').textContent = this.subtitle
                let listItem = document.createElement('li')
                    listItem.dataset.taskId = this.id
                    listItem.classList.add('tasklist--item')
                    listItem.appendChild(newTaskElement)
                taskList.appendChild(listItem)
            }

            
            toggleModMenu(){
                this.taskElement.querySelector('.task--modMenu').classList.toggle('hidden')
            }


            clickAwayFromModMenu(e) {
                let taskElement = e.target.closest('.tasklist--item')
                let targetTask = tasks.find(task => task.id == taskElement.dataset.taskId)
                if (e.relatedTarget !== targetTask.modButtons[0] && e.relatedTarget !== targetTask.modButtons[1]) {
                    targetTask.toggleModMenu()
                }
            }


            longHoldHandler(e){
                if(e.type === "mousedown" || e.type === "touchstart"){
                    holdTimer = setTimeout(() => {
                        let targetTask = tasks.find(task => task.id == this.dataset.taskId)
                        targetTask.toggleModMenu()
                        targetTask.modButtons[0].focus()
                    }, holdDuration);
                } else if(e.type === "mouseup" || e.type === "touchend"){
                    clearTimeout(holdTimer)
                }
            }

            deleteTask(){
                this.stopTimer()
                this.removeListeners()
                this.taskElement.remove()
            }

            recoverTask(){
                this.createTaskElement()
                if(this.active){
                    this.startTimer()
                } else {
                    this.updateTimerElement()
                }
                this.addListeners()
            }

        }
        /* #endregion || task class */


        function backupTasksToLocalStorage(){
            localStorage.setItem('persistentTasks', JSON.stringify(tasks))
        }

        function recoverLocalStorageTasks(){
            recoveredTasks = JSON.parse(localStorage.getItem('persistentTasks'))

            recoveredTasks.forEach(task => {
                task = Object.assign(new Task, task)
                tasks.push(task)
                task.recoverTask()
                return task
            })

        }



        /* #region || wait for document to load */
        window.addEventListener('load', () => {

            detectTouchDevice()

            if (localStorage.getItem("persistentTasks") !== null) {
                recoverLocalStorageTasks()
            }

        })
        /* #endregion || wait for document to load */

    </script>



<!-- #region || task template -->
<template class="task-template">
    <div class="task">

        <button data-action="toggle" class="task--btn-toggle">
            <span class="task--icon material-icons">play_arrow</span>
        </button>

        <button data-action="main" class="task--btn-main">

            <span class="task--details">
                <span class="task--title">Task Title</span>
                <span class="task--subtitle hidden">Task Subtitle</span>
            </span>
    
            <span class="task--timer">
                <span data-hrs>00</span>:
                <span data-min>00</span>:
                <span data-sec>00</span>
            </span>

        </button>

        <button data-action="open" class="task--btn-open">
            <span class="task--icon material-icons">navigate_next</span>
        </button>

        <span class="task--modMenu hidden">

            <button data-action="edit" class="task--btn-edit">
                <span>Edit</span>
            </button>

            <button data-action="delete" class="task--btn-delete">
                <span>Delete</span>
            </button>

        </span>
        
    </div>
</template>
<!-- #endregion || task template -->

</body>
</html>